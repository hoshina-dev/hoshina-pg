name: Build hoshina-pg

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      semantic_version:
        description: 'Semantic version (e.g. 1.2.3).'
        required: false

env:
  DOCKERFILE_PATH: Dockerfile
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE_NAME: hoshina-pg
  LOCAL_REGISTRY: localhost:5000
  LOCAL_REGISTRY_NAME: temp-registry

jobs:
  prepare:
    name: Prepare variables
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.set.outputs.semver }}
      tag_version: ${{ steps.set.outputs.tag_version }}
      ghcr_image_full: ${{ steps.set.outputs.ghcr_image_full }}
      pg_major: ${{ steps.set.outputs.pg_major }}
      postgis_major: ${{ steps.set.outputs.postgis_major }}
      pgdg_codename: ${{ steps.set.outputs.pgdg_codename }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read versions from Dockerfile and determine tags
        id: set
        run: |
          set -eux
          FILE="${{ env.DOCKERFILE_PATH }}"

          extract() {
            local key="$1"
            local val
            val=$(grep -m1 -E "^ARG[[:space:]]+${key}=" "$FILE" || true)
            if [ -n "$val" ]; then
              echo "$val" | sed -E "s/^ARG[[:space:]]+${key}=(.*)/\1/"
            else
              echo ""
            fi
          }

          PG_MAJOR=$(extract PG_MAJOR)
          POSTGIS_MAJOR=$(extract POSTGIS_MAJOR)
          PGDG_CODENAME=$(extract PGDG_CODENAME)

          PG_MAJOR=${PG_MAJOR:-}
          POSTGIS_MAJOR=${POSTGIS_MAJOR:-}
          PGDG_CODENAME=${PGDG_CODENAME:-}

          # determine semver
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            SEMVER=${GITHUB_REF#refs/tags/}
          else
            SEMVER="${{ github.event.inputs.semantic_version }}"
            if [ -z "$SEMVER" ]; then
              echo "No semantic version provided. Provide a tag (X.Y.Z) or workflow input 'semantic_version'." >&2
              exit 1
            fi
          fi

          GHCR_IMAGE_FULL="${{ env.GHCR_REGISTRY }}/${{ github.repository_owner }}/${{ env.GHCR_IMAGE_NAME }}"
          TAG_VERSION="$PG_MAJOR-$SEMVER"

          echo "semver=$SEMVER" >> $GITHUB_OUTPUT
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "ghcr_image_full=$GHCR_IMAGE_FULL" >> $GITHUB_OUTPUT
          echo "pg_major=$PG_MAJOR" >> $GITHUB_OUTPUT
          echo "postgis_major=$POSTGIS_MAJOR" >> $GITHUB_OUTPUT
          echo "pgdg_codename=$PGDG_CODENAME" >> $GITHUB_OUTPUT

  build-amd64:
    name: Build (amd64)
    needs: prepare
    runs-on: ubuntu-24.04
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd="wget --quiet --tries=1 --spider http://localhost:5000/v2/ || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Configure Docker for insecure registry
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/config.json <<EOF
          {
            "insecureRegistries": ["localhost:5000"]
          }
          EOF

      - name: Wait for registry to be ready
        run: |
          set -eux
          for i in {1..30}; do
            if wget --quiet --tries=1 --spider http://127.0.0.1:5000/v2/; then
              echo "Registry is ready"
              exit 0
            fi
            echo "Waiting for registry... ($i/30)"
            sleep 2
          done
          echo "Registry failed to start"
          exit 1

      - name: Build and push amd64 image to local registry
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64
          push: true
          tags: |
            localhost:5000/${{ env.GHCR_IMAGE_NAME }}:${{ needs.prepare.outputs.tag_version }}-amd64
            localhost:5000/${{ env.GHCR_IMAGE_NAME }}:latest-amd64

  build-arm64:
    name: Build (arm64)
    needs: prepare
    runs-on: ubuntu-24.04-arm
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd="wget --quiet --tries=1 --spider http://localhost:5000/v2/ || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Configure Docker for insecure registry
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/config.json <<EOF
          {
            "insecureRegistries": ["localhost:5000"]
          }
          EOF

      - name: Wait for registry to be ready
        run: |
          set -eux
          for i in {1..30}; do
            if wget --quiet --tries=1 --spider http://127.0.0.1:5000/v2/; then
              echo "Registry is ready"
              exit 0
            fi
            echo "Waiting for registry... ($i/30)"
            sleep 2
          done
          echo "Registry failed to start"
          exit 1

      - name: Build and push arm64 image to local registry
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/arm64
          push: true
          tags: |
            localhost:5000/${{ env.GHCR_IMAGE_NAME }}:${{ needs.prepare.outputs.tag_version }}-arm64
            localhost:5000/${{ env.GHCR_IMAGE_NAME }}:latest-arm64

  push-to-ghcr:
    name: Create manifests & push to GHCR
    needs:
      - build-amd64
      - build-arm64
      - prepare
    runs-on: ubuntu-24.04
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
        options: >-
          --health-cmd="wget --quiet --tries=1 --spider http://localhost:5000/v2/ || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Configure Docker for insecure registry
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/config.json <<EOF
          {
            "insecureRegistries": ["localhost:5000"]
          }
          EOF

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for registry to be ready
        run: |
          set -eux
          for i in {1..30}; do
            if wget --quiet --tries=1 --spider http://127.0.0.1:5000/v2/; then
              echo "Registry is ready"
              exit 0
            fi
            echo "Waiting for registry... ($i/30)"
            sleep 2
          done
          echo "Registry failed to start"
          exit 1

      - name: Create and push multi-arch manifest for version tag
        run: |
          set -eux
          LOCAL_IMAGE="localhost:5000/${{ env.GHCR_IMAGE_NAME }}"
          GHCR_IMAGE="${{ needs.prepare.outputs.ghcr_image_full }}"
          TAG_VERSION="${{ needs.prepare.outputs.tag_version }}"

          docker buildx imagetools create --tag ${GHCR_IMAGE}:${TAG_VERSION} \
            ${LOCAL_IMAGE}:${TAG_VERSION}-amd64 \
            ${LOCAL_IMAGE}:${TAG_VERSION}-arm64

          docker pull ${GHCR_IMAGE}:${TAG_VERSION}
          docker push ${GHCR_IMAGE}:${TAG_VERSION}

      - name: Create and push multi-arch manifest for latest tag
        run: |
          set -eux
          LOCAL_IMAGE="localhost:5000/${{ env.GHCR_IMAGE_NAME }}"
          GHCR_IMAGE="${{ needs.prepare.outputs.ghcr_image_full }}"

          docker buildx imagetools create --tag ${GHCR_IMAGE}:latest \
            ${LOCAL_IMAGE}:latest-amd64 \
            ${LOCAL_IMAGE}:latest-arm64

          docker pull ${GHCR_IMAGE}:latest
          docker push ${GHCR_IMAGE}:latest

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.semver }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release body with Dockerfile values
        if: always()
        run: |
          set -eux
          SEMVER="${{ needs.prepare.outputs.semver }}"
          PG_MAJOR="${{ needs.prepare.outputs.pg_major }}"
          POSTGIS_MAJOR="${{ needs.prepare.outputs.postgis_major }}"
          PGDG_CODENAME="${{ needs.prepare.outputs.pgdg_codename }}"
          GHCR_IMAGE_FULL="${{ needs.prepare.outputs.ghcr_image_full }}"
          TAG_VERSION="${{ needs.prepare.outputs.tag_version }}"

          RELEASE_TAG="${SEMVER}"

          BODY="Postgres version: ${PG_MAJOR}\n\n# Extension version\nPostgis: ${POSTGIS_MAJOR}\n\nPGDG codename: ${PGDG_CODENAME}\n\nDocker images pushed:\n- ${GHCR_IMAGE_FULL}:${TAG_VERSION}\n- ${GHCR_IMAGE_FULL}:latest\n"

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${RELEASE_TAG}"
          release_id=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "$API_URL" | jq -r .id)
          if [ "$release_id" = "null" ] || [ -z "$release_id" ]; then
            curl -s -X POST -H "Authorization: token ${GITHUB_TOKEN}" \
              -d "{\"tag_name\": \"${RELEASE_TAG}\", \"name\": \"${RELEASE_TAG}\", \"body\": \"${BODY}\"}" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases" | jq .
          else
            curl -s -X PATCH -H "Authorization: token ${GITHUB_TOKEN}" \
              -d "{\"body\": \"${BODY}\"}" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/${release_id}" | jq .
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
